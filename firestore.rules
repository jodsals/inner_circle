rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    /// Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    /// Get user data from Firestore
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /// Check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    /// Check if user is moderator or admin
    function isModerator() {
      return isAuthenticated() && getUserData().role in ['moderator', 'admin'];
    }

    /// Check if user owns this resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /// Validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    /// Validate string is not empty and within length
    function isValidString(text, minLen, maxLen) {
      return text is string &&
             text.size() >= minLen &&
             text.size() <= maxLen;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================

    match /users/{userId} {
      // Users can read their own profile, moderators and admins can read all
      allow read: if isOwner(userId) || isModerator();

      // Users can create their own document during registration
      allow create: if isAuthenticated() &&
                       isOwner(userId) &&
                       // Validate required fields
                       request.resource.data.keys().hasAll(['id', 'email', 'role']) &&
                       // Ensure ID matches
                       request.resource.data.id == userId &&
                       // Validate email
                       isValidEmail(request.resource.data.email) &&
                       // New users can only create with 'user' role
                       request.resource.data.role == 'user' &&
                       // Validate displayName if provided
                       (!request.resource.data.keys().hasAny(['displayName']) ||
                        isValidString(request.resource.data.displayName, 1, 50));

      // Users can update their own profile (except restricted fields)
      allow update: if isAuthenticated() &&
                       isOwner(userId) &&
                       // Cannot change these fields
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['id', 'email', 'role']) &&
                       // Validate displayName if changed
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['displayName']) ||
                        isValidString(request.resource.data.displayName, 1, 50));

      // Admins can update any user (including role changes)
      allow update: if isAdmin() &&
                       // Admin can change role to valid values
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) ||
                        request.resource.data.role in ['user', 'moderator', 'admin']);

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================
    // COMMUNITIES COLLECTION
    // ============================================

    match /communities/{communityId} {
      // Anyone (including unauthenticated) can read communities
      allow read: if true;

      // Only admins can create communities
      allow create: if isAdmin() &&
                       // Validate required fields
                       request.resource.data.keys().hasAll(['title', 'description']) &&
                       // Validate title
                       isValidString(request.resource.data.title, 3, 100) &&
                       // Validate description
                       isValidString(request.resource.data.description, 10, 1000) &&
                       // Ensure memberCount is initialized
                       request.resource.data.memberCount == 0;

      // Admins can update all community fields
      allow update: if isAdmin() &&
                       // Validate title if changed
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['title']) ||
                        isValidString(request.resource.data.title, 3, 100)) &&
                       // Validate description if changed
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['description']) ||
                        isValidString(request.resource.data.description, 10, 1000));

      // Authenticated users can update memberCount (for join/leave operations)
      allow update: if isAuthenticated() &&
                       // Only memberCount can be changed
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount']) &&
                       // MemberCount must be a number
                       request.resource.data.memberCount is int &&
                       // MemberCount can only increase or decrease by 1
                       (request.resource.data.memberCount == resource.data.memberCount + 1 ||
                        request.resource.data.memberCount == resource.data.memberCount - 1);

      // Authenticated users can update likeCount (for like/unlike operations)
      allow update: if isAuthenticated() &&
                       // Only likeCount can be changed
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']) &&
                       // LikeCount must be a number
                       request.resource.data.likeCount is int &&
                       // LikeCount can only increase or decrease by 1
                       (request.resource.data.likeCount == resource.data.likeCount + 1 ||
                        request.resource.data.likeCount == resource.data.likeCount - 1);

      // Only admins can delete communities
      allow delete: if isAdmin();

      // ============================================
      // FORUMS SUBCOLLECTION
      // ============================================

      match /forums/{forumId} {
        // Anyone (including unauthenticated) can read forums
        allow read: if true;

        // Only admins can create forums
        allow create: if isAdmin() &&
                         // Validate required fields
                         request.resource.data.keys().hasAll(['title']) &&
                         // Validate title
                         isValidString(request.resource.data.title, 3, 100);

        // Only admins can update forums
        allow update: if isAdmin() &&
                         // Validate title if changed
                         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['title']) ||
                          isValidString(request.resource.data.title, 3, 100));

        // Only admins can delete forums
        allow delete: if isAdmin();

        // ============================================
        // POSTS SUBCOLLECTION (für zukünftige Implementierung)
        // ============================================

        match /posts/{postId} {
          // Anyone can read posts
          allow read: if true;

          // Authenticated users can create posts
          allow create: if isAuthenticated() &&
                           // Validate required fields
                           request.resource.data.keys().hasAll(['authorId', 'title', 'content']) &&
                           // Ensure author is current user
                           request.resource.data.authorId == request.auth.uid &&
                           // Validate title
                           isValidString(request.resource.data.title, 5, 200) &&
                           // Validate content
                           isValidString(request.resource.data.content, 10, 10000);

          // Users can update their own posts, moderators can update any
          allow update: if (isAuthenticated() &&
                           resource.data.authorId == request.auth.uid &&
                           // Cannot change author
                           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['authorId'])) ||
                           isModerator();

          // Users can delete their own posts, moderators can delete any
          allow delete: if (isAuthenticated() && resource.data.authorId == request.auth.uid) ||
                           isModerator();

          // ============================================
          // COMMENTS SUBCOLLECTION (für zukünftige Implementierung)
          // ============================================

          match /comments/{commentId} {
            // Anyone can read comments
            allow read: if true;

            // Authenticated users can create comments
            allow create: if isAuthenticated() &&
                             // Validate required fields
                             request.resource.data.keys().hasAll(['authorId', 'content']) &&
                             // Ensure author is current user
                             request.resource.data.authorId == request.auth.uid &&
                             // Validate content
                             isValidString(request.resource.data.content, 1, 2000);

            // Users can update their own comments, moderators can update any
            allow update: if (isAuthenticated() &&
                             resource.data.authorId == request.auth.uid &&
                             !request.resource.data.diff(resource.data).affectedKeys().hasAny(['authorId'])) ||
                             isModerator();

            // Users can delete their own comments, moderators can delete any
            allow delete: if (isAuthenticated() && resource.data.authorId == request.auth.uid) ||
                             isModerator();
          }
        }
      }
    }

    // ============================================
    // MEMBERSHIPS COLLECTION
    // ============================================

    match /memberships/{membershipId} {
      // Anyone can read memberships (to check if user is member)
      allow read: if true;

      // Authenticated users can create their own memberships
      allow create: if isAuthenticated() &&
                       // Validate required fields
                       request.resource.data.keys().hasAll(['userId', 'communityId']) &&
                       // Ensure user is creating their own membership
                       request.resource.data.userId == request.auth.uid;

      // Users can delete their own memberships (leave community)
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // ============================================
    // COMMUNITY LIKES COLLECTION
    // ============================================

    match /communityLikes/{likeId} {
      // Anyone can read likes (to check if user has liked)
      allow read: if true;

      // Authenticated users can create their own likes
      allow create: if isAuthenticated() &&
                       // Validate required fields
                       request.resource.data.keys().hasAll(['userId', 'communityId']) &&
                       // Ensure user is creating their own like
                       request.resource.data.userId == request.auth.uid;

      // Users can delete their own likes (unlike community)
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // ============================================
    // HEALTH PROFILES COLLECTION (für zukünftige Implementierung)
    // ============================================

    match /healthProfiles/{userId} {
      // Users can only read their own health profile
      allow read: if isOwner(userId);

      // Users can create their own health profile
      allow create: if isAuthenticated() &&
                       isOwner(userId) &&
                       request.resource.data.keys().hasAll(['userId']);

      // Users can update their own health profile
      allow update: if isAuthenticated() && isOwner(userId);

      // Users can delete their own health profile
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ============================================
    // SURVEYS COLLECTION (für zukünftige Implementierung)
    // ============================================

    match /surveys/{surveyId} {
      // Only authenticated users can read surveys
      allow read: if isAuthenticated();

      // Only admins can create/update/delete surveys
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // SURVEY RESPONSES COLLECTION (für zukünftige Implementierung)
    // ============================================

    match /surveyResponses/{responseId} {
      // Users can only read their own survey responses
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Users can create their own survey responses
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users cannot update or delete survey responses (immutable)
      allow update, delete: if false;
    }
  }
}